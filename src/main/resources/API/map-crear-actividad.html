<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Actividad</title>
    <!-- CAMBIO CR√çTICO: Usar Leaflet 1.7.1 en lugar de 1.9.4 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        /* Eliminar cualquier margen/padding */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        /* Posicionamiento absoluto para forzar dimensiones */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: #e5e7eb;
        }

        /* Estilos del marcador personalizado */
        .custom-marker {
            background-color: #1563e2;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .custom-popup .leaflet-popup-content-wrapper {
            background: #1563e2;
            color: #fff;
            border-radius: 8px;
            font-family: sans-serif;
            font-size: 14px;
        }

        .custom-popup .leaflet-popup-tip {
            background: #1563e2;
        }

        .custom-popup a {
            color: white;
        }
    </style>
</head>
<body>
<div id="map"></div>

<!-- CAMBIO CR√çTICO: Usar Leaflet 1.7.1 -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    var map;
    var marker;
    var mapInitialized = false;

    function initializeLeafletMap() {
        if (mapInitialized) {
            console.log('‚ö†Ô∏è Mapa ya inicializado');
            return;
        }

        console.log('üó∫Ô∏è Inicializando Leaflet Map...');

        // Configuraci√≥n optimizada para JavaFX
        map = L.map('map', {
            center: [40.4168, -3.7038],
            zoom: 5,
            zoomControl: true,
            // NUEVAS OPCIONES para mejorar rendimiento en JavaFX
            preferCanvas: true,
            fadeAnimation: false,
            zoomAnimation: false,
            markerZoomAnimation: false
        });

        // Configuraci√≥n mejorada del TileLayer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 19,
            keepBuffer: 8,
            updateWhenZooming: false,
            updateWhenIdle: true
        }).addTo(map);

        mapInitialized = true;
        console.log('‚úÖ Leaflet Map inicializado');

        // Llamar autom√°ticamente a onWebViewReady
        if (typeof window.onWebViewReady === 'function') {
            window.onWebViewReady();
        }
    }

    // Funci√≥n llamada desde Java cuando el WebView est√° listo
    window.onWebViewReady = function() {
        console.log('üì° onWebViewReady llamado');

        if (!mapInitialized) {
            initializeLeafletMap();
        }

        // Invalidaciones m√∫ltiples y progresivas
        var intervals = [100, 300, 500, 800, 1200];
        intervals.forEach(function(time) {
            setTimeout(function() {
                if (map) {
                    map.invalidateSize(true);
                    console.log('üîÑ invalidateSize ejecutado: ' + time + 'ms');
                }
            }, time);
        });
    };

    // Funci√≥n llamada desde Java para actualizar ubicaci√≥n
    window.updateMapLocation = function(lat, lng, label) {
        console.log('üìç updateMapLocation llamado:', lat, lng, label);

        if (!mapInitialized) {
            console.log('‚ö†Ô∏è Mapa no inicializado, inicializando...');
            initializeLeafletMap();
        }

        var latNum = parseFloat(lat);
        var lngNum = parseFloat(lng);

        console.log('üî¢ Coordenadas parseadas: latNum=', latNum, 'lngNum=', lngNum);

        if (isNaN(latNum) || isNaN(lngNum)) {
            console.error('‚ùå Coordenadas inv√°lidas. Verifique separador decimal.');
            return;
        }

        // Remover marcador anterior si existe
        if (marker) {
            map.removeLayer(marker);
            console.log('üóëÔ∏è Marcador anterior eliminado');
        }

        // Crear icono personalizado
        var icon = L.divIcon({
            className: 'custom-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
        });

        // A√±adir nuevo marcador
        marker = L.marker([latNum, lngNum], {icon: icon}).addTo(map);
        console.log('üìå Marcador a√±adido');

        // A√±adir popup si hay etiqueta
        if (label) {
            marker.bindPopup('<b>' + label + '</b>', {
                className: 'custom-popup'
            }).openPopup();
        }

        // Centrar mapa en la ubicaci√≥n (sin animaci√≥n para evitar bugs)
        map.setView([latNum, lngNum], 16, { animate: false });
        console.log('üéØ Vista centrada en:', latNum, lngNum);

        // Forzar invalidaci√≥n despu√©s de centrar
        setTimeout(function() {
            map.invalidateSize(true);
            console.log('üîÑ invalidateSize final ejecutado');
        }, 150);
    };

    // Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeLeafletMap);
    } else {
        initializeLeafletMap();
    }

    console.log('‚úÖ Script del mapa cargado');
</script>
</body>
</html>
