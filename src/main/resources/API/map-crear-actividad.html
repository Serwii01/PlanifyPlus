<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Actividad</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        /* CRÍTICO: Asegurar que el div del mapa ocupe el 100% del contenedor */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; }
        #map { height: 100%; width: 100%; background: #e5e7eb; }

        /* Estilos del marcador (por estética) */
        .custom-marker {
            background-color: #1563e2;
            width: 30px; height: 30px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .custom-popup .leaflet-popup-content-wrapper {
            background: #1563e2;
            color: #fff;
            border-radius: 8px;
            font-family: sans-serif;
            font-size: 14px;
        }
        .custom-popup .leaflet-popup-tip { background: #1563e2; }
        .custom-popup a { color: white; }
    </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map;
    var marker;
    var mapInitialized = false;

    function initializeLeafletMap() {
        if (mapInitialized) return;

        map = L.map('map', {
            center: [40.4168, -3.7038], // Centro de España por defecto
            zoom: 5,
            zoomControl: true
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        mapInitialized = true;
        console.log('Leaflet Map inicializado.');

        // Llamar a onWebViewReady inmediatamente después de la creación
        window.onWebViewReady();
    }

    // FUNCIÓN DE SINCRONIZACIÓN DE JAVA: Forzar Redibujado
    window.onWebViewReady = function() {
        if (!mapInitialized) initializeLeafletMap();

        // Ejecutamos invalidateSize varias veces para asegurar que Leaflet vea el tamaño real.
        var intervals = [0, 50, 200, 500];
        intervals.forEach(function(time) {
            setTimeout(function() {
                if(map) {
                    // Usamos 'true' para forzar una detección de tamaño más agresiva
                    map.invalidateSize(true);
                    console.log('invalidateSize ejecutado después de ' + time + 'ms');
                }
            }, time);
        });
    };

    // Esta función la llama Java para poner el marcador
    window.updateMapLocation = function(lat, lng, label) {
        if (!mapInitialized) initializeLeafletMap();

        var latNum = parseFloat(lat);
        var lngNum = parseFloat(lng);

        console.log('JS recibiendo: Lat=', lat, 'Lng=', lng, 'Parsed LatNum=', latNum, 'LngNum=', lngNum);

        if (isNaN(latNum) || isNaN(lngNum)) {
            console.error("Coordenadas inválidas recibidas. Verifique el separador decimal en la consola de Java.");
            return;
        }

        // Mover marcador
        if (marker) map.removeLayer(marker);

        var icon = L.divIcon({
            className: 'custom-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
        });

        marker = L.marker([latNum, lngNum], {icon: icon}).addTo(map);

        if(label) {
            marker.bindPopup("<b>" + label + "</b>", {
                className: 'custom-popup'
            }).openPopup();
        }

        // Centrar y hacer zoom en la ubicación sin animación para evitar conflictos de timing.
        map.setView([latNum, lngNum], 16, { animate: false });

        // Forzar repintado tras el movimiento final (por si acaso).
        setTimeout(function(){
            map.invalidateSize(true);
        }, 100);
    };

    // Arranque inicial.
    initializeLeafletMap();
</script>
</body>
</html>