<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Actividad</title>
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { margin:0; padding:0; overflow:hidden; }
        #map { height:100vh; width:100%; background:#f3f4f6; }
        .custom-marker {
            background-color:#1563e2;
            width:30px; height:30px;
            border-radius:50%;
            border:3px solid #fff;
            box-shadow:0 2px 8px rgba(0,0,0,.3);
        }
        .custom-popup .leaflet-popup-content-wrapper {
            background:#1563e2;
            color:#fff;
            border-radius:12px;
        }
        .custom-popup .leaflet-popup-tip { background:#1563e2; }
    </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    console.log('Iniciando mapa Leaflet');
    var map;
    var marker;

    function initMap() {
        map = L.map('map', {
            center:[40.4168, -3.7038],
            zoom:6
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution:'Â© OpenStreetMap contributors',
            maxZoom:19
        }).addTo(map);

        // Fix para WebView
        setTimeout(function () {
            map.invalidateSize();
        }, 300);

        console.log('Mapa inicializado');
    }

    function updateMapLocation(lat, lng, label) {
        if (!map) return;
        console.log('updateMapLocation:', lat, lng, label);

        if (marker) {
            map.removeLayer(marker);
        }

        var icon = L.divIcon({
            className:'custom-marker',
            iconSize:[30,30],
            iconAnchor:[15,15],
            popupAnchor:[0,-15]
        });

        marker = L.marker([lat, lng], {icon:icon}).addTo(map);
        marker.bindPopup('<b>' + label + '</b>', {
            className:'custom-popup',
            maxWidth:280
        }).openPopup();

        map.setView([lat, lng], 15);
    }

    document.addEventListener('DOMContentLoaded', function () {
        initMap();
    });

    window.addEventListener('resize', function () {
        if (map) {
            setTimeout(function () { map.invalidateSize(); }, 100);
        }
    });
</script>
</body>
</html>
