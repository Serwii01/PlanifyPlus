<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Ubicaci√≥n</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background:#F5F8FB;
            padding:16px;
        }
        .search-container {
            position:relative;
            max-width:600px;
            margin:0 auto;
        }
        #searchInput {
            width:100%;
            padding:12px 16px;
            font-size:15px;
            border:2px solid #E5E7EB;
            border-radius:12px;
            outline:none;
            transition:all .3s;
        }
        #searchInput:focus {
            border-color:#1563e2;
            box-shadow:0 0 0 3px rgba(21,99,226,.1);
        }
        #results {
            position:absolute;
            top:100%;
            left:0; right:0;
            background:white;
            border:1px solid #E5E7EB;
            border-radius:12px;
            margin-top:8px;
            max-height:300px;
            overflow-y:auto;
            box-shadow:0 4px 12px rgba(0,0,0,.1);
            display:none;
            z-index:1000;
        }
        .result-item {
            padding:12px 16px;
            cursor:pointer;
            border-bottom:1px solid #f3f4f6;
            transition:background .2s;
        }
        .result-item:last-child { border-bottom:none; }
        .result-item:hover { background:#F5F8FB; }
        .result-item strong { color:#1563e2; }
        .result-type { font-size:11px; color:#6b7280; margin-top:4px; }
        .no-results, .loading, .error {
            padding:16px;
            text-align:center;
            color:#6b7280;
        }
        .error { color:#dc2626; }
        .selected-location {
            margin-top:16px;
            padding:12px 16px;
            background:#dbeafe;
            border-radius:12px;
            display:none;
        }
        .selected-location.show { display:block; }
        .selected-location strong { color:#1d4ed8; }
    </style>
</head>
<body>
<div class="search-container">
    <input id="searchInput"
           type="text"
           placeholder="üîç Busca direcci√≥n, plaza, parque, estadio..."
           autocomplete="off"/>
    <div id="results"></div>
    <div id="selectedLocation" class="selected-location">
        <strong>üìç Ubicaci√≥n seleccionada:</strong>
        <div id="locationText"></div>
    </div>
</div>

<script>
    console.log('üöÄ Buscador de ubicaci√≥n iniciando...');

    const searchInput = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('results');
    const selectedLocationDiv = document.getElementById('selectedLocation');
    const locationTextDiv = document.getElementById('locationText');

    let searchTimeout;
    let lastSearchTime = 0;
    let cityContext = '';

    // Variables globales para que Java las pueda leer por polling
    window.selectedLat = null;
    window.selectedLon = null;

    const SPAIN_BOUNDS = {
        minLat: 36.0,
        maxLat: 43.8,
        minLon: -9.3,
        maxLon: 4.3
    };

    window.setCityContext = function(city) {
        cityContext = city;
        console.log('üìç Ciudad contexto establecida:', cityContext);
    };

    searchInput.addEventListener('input', function () {
        const query = this.value.trim();
        clearTimeout(searchTimeout);

        if (query.length < 3) {
            resultsDiv.style.display = 'none';
            return;
        }

        resultsDiv.innerHTML = '<div class="loading">üîç Buscando...</div>';
        resultsDiv.style.display = 'block';

        searchTimeout = setTimeout(() => {
            const now = Date.now();
            if (now - lastSearchTime < 1000) {
                setTimeout(() => searchLocation(query), 1000 - (now - lastSearchTime));
            } else {
                searchLocation(query);
            }
        }, 800);
    });

    function searchLocation(query) {
        lastSearchTime = Date.now();

        let searchQuery = query;
        if (cityContext) {
            searchQuery = `${query}, ${cityContext}, Espa√±a`;
        } else if (!/espa√±a|spain/i.test(query)) {
            searchQuery = `${query}, Espa√±a`;
        }

        const url = 'https://nominatim.openstreetmap.org/search?' +
            'format=json&addressdetails=1&limit=15&extratags=1&countrycodes=es&bounded=1' +
            '&viewbox=-9.3,43.8,4.3,36.0' +
            '&q=' + encodeURIComponent(searchQuery);

        console.log('üîç Buscando:', searchQuery);

        fetch(url, {
            headers: { 'User-Agent': 'PlanifyPlus-JavaFX-App/1.0' }
        })
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(data => {
                const filtered = data.filter(r => {
                    const lat = parseFloat(r.lat);
                    const lon = parseFloat(r.lon);
                    const ok = lat >= SPAIN_BOUNDS.minLat && lat <= SPAIN_BOUNDS.maxLat &&
                        lon >= SPAIN_BOUNDS.minLon && lon <= SPAIN_BOUNDS.maxLon;
                    if (!ok) console.log('‚ùå Descartado fuera de Espa√±a:', r.display_name);
                    return ok;
                });
                displayResults(filtered, query);
            })
            .catch(err => {
                console.error('‚ùå Error en b√∫squeda:', err);
                resultsDiv.innerHTML = '<div class="error">‚ö†Ô∏è Error al buscar. Intenta de nuevo.</div>';
            });
    }

    function displayResults(results, query) {
        resultsDiv.innerHTML = '';

        if (!results.length) {
            resultsDiv.innerHTML = '<div class="no-results">‚ùå No se encontraron resultados en Espa√±a.</div>';
            resultsDiv.style.display = 'block';
            return;
        }

        results.sort((a, b) => {
            const order = { stadium:1, sports_centre:1, park:2, pitch:2,
                leisure:3, amenity:4, building:5, place:6 };
            const oa = order[a.type] || 10;
            const ob = order[b.type] || 10;
            if (oa === ob) {
                const ia = parseFloat(a.importance) || 0;
                const ib = parseFloat(b.importance) || 0;
                return ib - ia;
            }
            return oa - ob;
        });

        const regex = new RegExp('(' + escapeRegExp(query) + ')', 'gi');

        results.forEach(r => {
            const div = document.createElement('div');
            div.className = 'result-item';
            const highlighted = r.display_name.replace(regex, '<strong>$1</strong>');
            div.innerHTML = highlighted + '<div class="result-type">' + getPlaceType(r) + '</div>';
            div.addEventListener('click', () => selectLocation(r));
            resultsDiv.appendChild(div);
        });

        resultsDiv.style.display = 'block';
    }

    function getPlaceType(r) {
        const t = {
            stadium:'üèüÔ∏è Estadio',
            park:'üå≥ Parque',
            pitch:'‚öΩ Campo deportivo',
            sports_centre:'üèãÔ∏è Centro deportivo',
            building:'üè¢ Edificio',
            place:'üìç Lugar',
            leisure:'üé≠ Ocio',
            amenity:'üèõÔ∏è Instalaci√≥n',
            road:'üõ£Ô∏è Calle',
            house_number:'üè† Direcci√≥n'
        };
        return t[r.type] || 'üìç Ubicaci√≥n';
    }

    function selectLocation(r) {
        const lat = parseFloat(r.lat);
        const lon = parseFloat(r.lon);

        const inSpain = lat >= SPAIN_BOUNDS.minLat && lat <= SPAIN_BOUNDS.maxLat &&
            lon >= SPAIN_BOUNDS.minLon && lon <= SPAIN_BOUNDS.maxLon;
        if (!inSpain) {
            alert('La ubicaci√≥n seleccionada no est√° en Espa√±a. Elige otra.');
            return;
        }

        const displayName = r.display_name;
        console.log('‚úÖ Ubicaci√≥n seleccionada:', displayName);
        console.log('   üìç Lat:', lat);
        console.log('   üìç Lon:', lon);

        // Guardar en variables globales para que Java las pueda leer por polling
        window.selectedLat = lat;
        window.selectedLon = lon;

        locationTextDiv.textContent = displayName;
        selectedLocationDiv.classList.add('show');
        resultsDiv.style.display = 'none';
        searchInput.value = displayName;

        // Intentar llamar a Java directamente (m√©todo 1)
        console.log('üîç Verificando javaApp...');
        console.log('   typeof javaApp:', typeof javaApp);

        if (typeof javaApp !== 'undefined' && javaApp) {
            console.log('‚úÖ javaApp existe, llamando a onLocationSelected...');
            try {
                javaApp.onLocationSelected(displayName, lat, lon);
                console.log('‚úÖ onLocationSelected ejecutado correctamente');
            } catch (e) {
                console.error('‚ùå Error llamando a javaApp.onLocationSelected:', e);
                console.log('‚ö†Ô∏è Java leer√° la ubicaci√≥n por polling como fallback');
            }
        } else {
            console.log('‚ö†Ô∏è javaApp no disponible, Java lo leer√° por polling');
        }
    }

    function escapeRegExp(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    document.addEventListener('click', e => {
        if (!e.target.closest('.search-container')) {
            resultsDiv.style.display = 'none';
        }
    });

    console.log('‚úÖ Buscador de ubicaci√≥n inicializado');
</script>
</body>
</html>
